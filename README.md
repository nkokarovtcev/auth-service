# Authentication Service with JWT and Keycloak

## Описание

Этот сервис предоставляет функционал аутентификации и авторизации пользователей с использованием JWT токенов и IDM
системы Keycloak. Сервис позволяет пользователям авторизоваться с использованием логина и пароля, а также предоставляет
API для управления пользователями. Основные задачи, которые решает сервис:

- Аутентификация пользователей с использованием JWT токенов.
- Управление пользователями (создание, изменение, удаление) для пользователей с ролью ADMIN.
- Изменение пароля для авторизованных пользователей.

## Архитектура

Сервис включает следующие компоненты:

1. **Сервис аутентификации**: Обрабатывает запросы на авторизацию и аутентификацию.
2. **Keycloak**: Управление пользователями и их ролями.
3. **PostgreSQL**: База данных для хранения данных Keycloak.
4. **PgAdmin**: Интерфейс управления базой данных PostgreSQL.

## Инструкции по сборке и запуску проекта

1. **Клонируйте репозиторий**

   ```bash
   git clone https://github.com/nkokarovtcev/auth-service.git
   ```

2. Запустите Docker Compose. Для запуска всех сервисов используйте следующую команду:

   ```bash
   docker-compose -f DockerCompose.yml up --build auth-service
   ```
   Это создаст и запустит следующие контейнеры:

    - Postgres: база данных для хранения данных Keycloak.
    - pgAdmin: веб-интерфейс для управления базой данных Postgres.
    - Keycloak: сервис управления пользователями и аутентификацией. Консоль администратора доступна по
      адресу [http://localhost:8081](http://localhost:8081).
    - auth-service: ваш сервис аутентификации, который будет взаимодействовать с Keycloak.

4. Настройте файл hosts для запуска сервиса в отладочном режиме (на localhost)

- В Windows: Добавьте следующую строку в файл C:\Windows\System32\drivers\etc\hosts:

  ```
  127.0.0.1   keycloak
- В macOS и Linux: Отредактируйте файл /etc/hosts и добавьте строку:

  ```
  127.0.0.1   keycloak
  ```
  Откройте терминал и выполните:
  ```
  sudo nano /etc/hosts
  ```
  или

  ```
  sudo vim /etc/hosts
  ```

  Добавьте строку и сохраните изменения.

## API

Основные методы:

- **GET /api/users**: Получить список всех пользователей. Требуется роль администратора.
- **GET /api/users/{userId}**: Получить пользователя по его ID. Требуется роль администратора.
- **POST /api/users**: Создать нового пользователя. Требуется роль администратора.
- **PUT /api/users/{userId}**: Обновить данные пользователя по его ID. Требуется роль администратора.
- **DELETE /api/users/{userId}**: Удалить пользователя по его ID. Требуется роль администратора.
- **POST /api/users/{userId}/password**: Изменить пароль пользователя по его ID. Требуется роль администратора.
- **POST /api/users/password**: Изменить собственный пароль текущего авторизованного пользователя.

Документация API доступна по адресу [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html).
Для доступа к документации API не требуется авторизация, но для выполнения запросов требуется JWT токен - см. раздел "
Авторизация".

### Авторизация

Для получения JWT токена выполните следующий запрос:

**Метод POST**  
[http://localhost:8081/realms/secure-client-realm/protocol/openid-connect/token](http://localhost:8081/realms/secure-client-realm/protocol/openid-connect/token)

### Тело запроса:

Формат: `urlencoded`

Параметры:

- `grant_type`: `password`
- `client_id`: `auth-service`
- `username`: `admin`
- `password`: `auth-service`

Результат:
Если запрос выполнен успешно, вы получите JSON-ответ с данными о токене:

```json
{
  "access_token": "TOKEN",
  // JWT токен, который используется для авторизации запросов
  "expires_in": 300,
  // Время действия токена в секундах
  "refresh_expires_in": 1800,
  // Время действия refresh токена в секундах
  "refresh_token": "REFRESH_TOKEN",
  // Токен, используемый для получения нового access токена после его истечения
  "token_type": "Bearer",
  // Тип токена, обычно Bearer
  "not-before-policy": 0,
  // Политика времени начала действия токена
  "session_state": "SESSION_STATE",
  // Идентификатор состояния сессии
  "scope": "profile email roles"
  // Области доступа, предоставленные токеном
}
```

Значение access_token используется для авторизации запросов к API. Добавьте его в заголовок Authorization в
формате `Bearer TOKEN`.
